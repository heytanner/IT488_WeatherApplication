<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Breezy Weather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .glass {
            background: rgba(255,255,255,.14);
        }
        .glass-dark {
            background: rgba(0,0,0,.22);
        }
        .text-shadow {
            text-shadow: 0 2px 12px rgba(0,0,0,.45)
        }
        .hide-scroll::-webkit-scrollbar {
            display: none
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none
        }
        .wind-compass {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 2rem auto 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1)
        }
        .compass-label {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            font-weight: bold;
        }
            .compass-label.north {
                top: 0;
                left: 50%;
                transform: translateX(-50%);
            }
            .compass-label.east {
                top: 50%;
                right: 0;
                transform: translateY(-50%);
            }
            .compass-label.south {
                bottom: 0;
                left: 50%;
                transform: translateX(-50%);
            }
            .compass-label.west {
                top: 50%;
                left: 0;
                transform: translateY(-50%);
            }
        .compass-needle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 50%;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1);
            transform-origin: bottom center;
            transform: translate(-50%, -100%) rotate(0deg);
            transition: transform 0.5s ease-in-out;
            z-index: 5;
            border-radius: 2px;
        }
        .compass-center {
            position: absolute;
            width: 16px;
            height: 16px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.3), 0 1px 6px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="min-h-screen text-white font-sans selection:bg-white/20">
    <!-- background -->
    <div class="fixed inset-0 -z-10 bg-gradient-to-br from-sky-500 via-blue-600 to-indigo-700"></div>

    <div class="mx-auto max-w-5xl px-4 py-6">
        <!-- header -->
        <header class="flex flex-col items-center gap-4">
            <h1 class="text-4xl font-bold text-shadow text-center">Breezy</h1>

            <div class="flex items-center gap-2">
                <button id="unitBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">°F</button>
                <button id="themeBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">Theme</button>
                <button id="loginBtn" class="glass hover:bg-white/25 active:scale-95 transition rounded-2xl px-3 py-2 text-sm">Login</button>
                <a href="#about" class="glass hover:bg-white/25 rounded-2xl px-3 py-2 text-sm">About</a>
            </div>
        </header>

        <!-- search -->
        <section class="mt-4">
            <div class="glass rounded-3xl p-2">
                <div class="flex items-center gap-2">
                    <input id="city" class="w-full bg-transparent outline-none placeholder-white/70 py-2" placeholder="Search city" />
                    <button id="useGps" class="glass rounded-2xl px-3 py-2">GPS</button>
                    <button id="go" class="bg-white text-gray-900 rounded-2xl px-4 py-2 font-medium">Search</button>
                </div>
            </div>
            <p class="mt-2 text-white/80 text-sm">Try: Indianapolis, Chicago, New York</p>
        </section>

        <!-- current -->
        <section class="mt-6 grid gap-4 md:grid-cols-3">
            <div class="md:col-span-2 rounded-3xl glass p-6">
                <div class="flex items-end justify-between">
                    <div>
                        <div id="place" class="text-xl sm:text-2xl font-medium">City</div>
                        <button id="favBtn" title="Save to favorites"
                                class="text-2xl leading-none opacity-90 hover:opacity-100 select-none">
                            ♡
                        </button>
                        <div id="dateNow" class="mt-1 text-white/80">Today</div>
                        <div class="mt-6 flex items-center gap-4">
                            <div id="temp" class="text-7xl sm:text-8xl leading-none">--°</div>
                            <div class="space-y-1">
                                <div id="summary" class="text-lg">Ready</div>
                                <div id="feels" class="text-white/80 text-sm">Feels like --°</div>
                                <div id="hiLo" class="text-white/80 text-sm">H --°  L --°</div>
                            </div>
                        </div>
                    </div>
                    <div id="bigIcon" class="text-7xl sm:text-8xl">☀️</div>
                </div>
            </div>
            <div class="rounded-3xl glass p-6">
                <dl class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
                    <div><dt class="opacity-80">Wind</dt><dd id="wind" class="text-lg">-- mph</dd></div>
                    <div><dt class="opacity-80">Humidity</dt><dd id="humidity" class="text-lg">--%</dd></div>
                    <div><dt class="opacity-80">Pressure</dt><dd id="pressure" class="text-lg">-- hPa</dd></div>
                    <div><dt class="opacity-80">Visibility</dt><dd id="visibility" class="text-lg">-- km</dd></div>
                </dl>
                <div id="compassPlaceholder"
                     class="mt-4 flex items-center justify-center rounded-2xl glass p-4 text-white/80 text-sm text-shadow">
                    <div class="wind-compass">
                        <div class="compass-label north">N</div>
                        <div class="compass-label east">E</div>
                        <div class="compass-label south">S</div>
                        <div class="compass-label west">W</div>
                        <div class="compass-needle"></div>
                        <div class="compass-center"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- hourly -->
        <section class="mt-6">
            <h2 class="mb-3 text-lg font-medium">Today</h2>
            <div class="hide-scroll overflow-x-auto whitespace-nowrap rounded-3xl glass p-3">
                <div id="hourRow" class="flex gap-3">
                    <div class="w-20 shrink-0 rounded-2xl bg-white/10 text-center py-3">
                        <div class="text-sm opacity-90">--</div>
                        <div class="text-2xl">☁️</div>
                        <div class="mt-1 text-lg">--°</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- daily -->
        <section class="mt-6">
            <h2 class="mb-3 text-lg font-medium">Next days</h2>
            <div id="daily" class="rounded-3xl glass">
                <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
                    <div class="w-32">Today</div>
                    <div class="text-2xl">⛅</div>
                    <div class="w-24 text-right">--°</div>
                    <div class="w-24 text-right opacity-80">--°</div>
                </div>
            </div>
        </section>

        <!-- radar -->
        <section class="mt-6">
            <h2 class="mb-3 text-lg font-medium">Map</h2>
            <div class="rounded-3xl glass overflow-hidden">
                <iframe id="radar"
                        title="Radar"
                        class="w-full"
                        style="height: 28rem; border: 0;"
                        loading="lazy"
                        referrerpolicy="no-referrer-when-downgrade"
                        src="">
                </iframe>
            </div>
        </section>

        <!-- footer -->
        <footer class="mt-10 pb-10 text-white/80 text-sm text-center">
            Data by Open-Meteo & Windy.com <br />
            IT488-01 | 2504B August 2025 Term - Purdue University Global - Team D - Weather App Project.
        </footer>
    </div>

    <script>
        const unitBtn = document.getElementById('unitBtn');
        const themeBtn = document.getElementById('themeBtn');
        const goBtn = document.getElementById('go');
        const gpsBtn = document.getElementById('useGps');
        const cityEl = document.getElementById('city');

        // UI fields
        const place = document.getElementById('place');
        const dateNow = document.getElementById('dateNow');
        const temp = document.getElementById('temp');
        const summary = document.getElementById('summary');
        const feels = document.getElementById('feels');
        const hiLo = document.getElementById('hiLo');
        const wind = document.getElementById('wind');
        const humidity = document.getElementById('humidity');
        const pressure = document.getElementById('pressure');
        const visibility = document.getElementById('visibility');

        let tempUnit = localStorage.getItem('unit') || 'fahrenheit';
        unitBtn.textContent = tempUnit === 'fahrenheit' ? '°F' : '°C';

        // Track last coordinates for favorites
        let lastLat = null, lastLon = null;

        // Toggle units
        unitBtn.addEventListener('click', () => {
            tempUnit = tempUnit === 'fahrenheit' ? 'celsius' : 'fahrenheit';
            unitBtn.textContent = tempUnit === 'fahrenheit' ? '°F' : '°C';
            localStorage.setItem('unit', tempUnit);
        });

        // Toggle theme
        themeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            document.querySelectorAll('.glass').forEach(c => c.classList.toggle('glass-dark'));
        });

        // Radar update
        function updateRadar(lat, lon) {
            const frame = document.getElementById('radar');
            if (!frame) return;
            frame.src = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=7&level=surface&overlay=radar`;
        }

        // Weather fetch
        async function goWeather(lat, lon, placeName = "Selected Location") {
            try {
                const res = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
                    `&current=temperature_2m,apparent_temperature,weather_code,wind_speed_10m,wind_direction_10m,relative_humidity_2m,pressure_msl,visibility` +
                    `&daily=temperature_2m_max,temperature_2m_min,weather_code` +
                    `&timezone=auto&temperature_unit=${tempUnit}`
                );
                const data = await res.json();

                // Update UI
                place.textContent = placeName;
                dateNow.textContent = new Date().toLocaleString([], { weekday: 'long', hour: '2-digit', minute: '2-digit' });
                temp.textContent = data.current.temperature_2m + "°";
                feels.textContent = "Feels like " + data.current.apparent_temperature + "°";
                hiLo.textContent = "H " + data.daily.temperature_2m_max[0] + "°  L " + data.daily.temperature_2m_min[0] + "°";
                summary.textContent = "Updated";

                wind.textContent = data.current.wind_speed_10m + " mph";
                humidity.textContent = data.current.relative_humidity_2m + "%";
                pressure.textContent = data.current.pressure_msl + " hPa";
                visibility.textContent = data.current.visibility + " m";


                // Wind direction
                const direction = data.current.wind_direction_10m || 0;
                const needle = document.querySelector('.compass-needle');
                needle.style.transform = `translate(-50%, -100%) rotate(${direction}deg)`;

                // Track last coords for favorites + radar update
                lastLat = lat; lastLon = lon;
                updateRadar(lat, lon);

                // Refresh Heart icon state
                updateFavoriteIcon();
            } catch (err) {
                console.error("Weather fetch failed", err);
                alert("Could not get weather data.");
            }
        }

        // Search handler
        goBtn.addEventListener('click', async () => {
            if (!cityEl.value) return;
            const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${cityEl.value}&count=1`);
            const geoData = await geoRes.json();
            if (geoData.results && geoData.results.length > 0) {
                const loc = geoData.results[0];
                goWeather(loc.latitude, loc.longitude, loc.name);
            } else {
                alert("City not found");
            }
        });

        // GPS handler
        gpsBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    goWeather(pos.coords.latitude, pos.coords.longitude, "Current Location");
                }, () => alert("Could not get location"));
            }
        });

        /* =========================
         Login / Front-end Auth
         ========================= */
        // Placeholder until a full favorites UI exists
        function renderFavorites() { /* intentionally empty for this sprint */ }

        function openLoginModal(mode = 'login') {
            modalMode = mode;
            updateModalMode();
            document.getElementById('loginModal').style.display = 'flex';
        }
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function getUsers() {
            try { return JSON.parse(localStorage.getItem('breezyUsers') || '{}'); }
            catch { return {}; }
        }
        function saveUsers(map) { localStorage.setItem('breezyUsers', JSON.stringify(map)); }

        function currentUserEmail() {
            return sessionStorage.getItem('breezySession') || localStorage.getItem('breezySession') || null;
        }
        function setSession(email, remember) {
            if (remember) {
                localStorage.setItem('breezySession', email);
                sessionStorage.removeItem('breezySession');
            } else {
                sessionStorage.setItem('breezySession', email);
                localStorage.removeItem('breezySession');
            }
        }
        function clearSession() {
            sessionStorage.removeItem('breezySession');
            localStorage.removeItem('breezySession');
        }
        function isSignedIn() { return !!currentUserEmail(); }

        // Login button behavior
        const loginBtn = document.getElementById('loginBtn');
        function updateAuthUI() {
            loginBtn.textContent = isSignedIn() ? 'Logout' : 'Login';
        }
        loginBtn.addEventListener('click', () => {
            if (isSignedIn()) {
                clearSession();
                updateAuthUI();
                renderFavorites();
                updateFavoriteIcon();
            } else {
                openLoginModal('login');
            }
        });

        let modalMode = 'login';
        function updateModalMode() {
            const title = document.getElementById('loginTitle');
            const action = document.getElementById('loginAction');
            const toggle = document.getElementById('toggleCreate');
            title.textContent = (modalMode === 'create') ? 'Create your account' : 'Sign in to save your favorite locations';
            action.textContent = (modalMode === 'create') ? 'Create account' : 'Login';
            toggle.innerHTML = (modalMode === 'create')
                ? 'Already have an account? <a href="#" id="toLogin">Sign in</a>'
                : 'Don’t have an account? <a href="#" id="toCreate">Create account</a>';
            setTimeout(() => {
                const toCreate = document.getElementById('toCreate');
                const toLogin = document.getElementById('toLogin');
                if (toCreate) toCreate.addEventListener('click', (e) => { e.preventDefault(); modalMode = 'create'; updateModalMode(); });
                if (toLogin) toLogin.addEventListener('click', (e) => { e.preventDefault(); modalMode = 'login'; updateModalMode(); });
            }, 0);
        }

        async function handleLogin() {
            const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
            const pass = (document.getElementById('loginPass').value || '').trim();
            const remember = document.getElementById('loginRemember').checked;
            if (!email || !pass) { alert('Please enter email and password.'); return; }

            const users = getUsers();
            if (modalMode === 'create') {
                if (users[email]) { alert('Account already exists. Sign in instead.'); return; }
                users[email] = { password: pass, createdAt: Date.now() };
                saveUsers(users);
                setSession(email, remember);
                closeLoginModal();
                updateAuthUI();
                renderFavorites();
                updateFavoriteIcon();
                return;
            }
            if (!users[email] || users[email].password !== pass) {
                alert('Invalid email or password.');
                return;
            }
            setSession(email, remember);
            closeLoginModal();
            updateAuthUI();
            renderFavorites();
            updateFavoriteIcon();
        }

        /* =========================
           Favorites (localStorage save/remove)
           ========================= */
        function favKey() { return 'breezy:favs:' + (currentUserEmail() || ''); }
        function getFavs() {
            if (!isSignedIn()) return [];
            try { return JSON.parse(localStorage.getItem(favKey()) || '[]'); }
            catch { return []; }
        }
        function saveFavs(f) { localStorage.setItem(favKey(), JSON.stringify(f)); }

        function inFavorites(name) {
            const f = getFavs();
            return f.some(x => (x.name || '').toLowerCase() === (name || '').toLowerCase());
        }
        function saveFavorite(name, lat, lon) {
            if (!isSignedIn()) return;
            const f = getFavs();
            if (!inFavorites(name)) {
                f.push({ name, lat, lon });
                saveFavs(f);
            }
        }
        function removeFavorite(name) {
            if (!isSignedIn()) return;
            const f = getFavs().filter(x => x.name.toLowerCase() !== name.toLowerCase());
            saveFavs(f);
        }

        function updateFavoriteIcon() {
            if (!favBtn) return;
            const nm = (place.textContent || '').trim();
            const saved = isSignedIn() && inFavorites(nm) && nm.length > 0;
            favBtn.textContent = saved ? '♥' : '♡';
            favBtn.title = saved ? 'Remove from favorites' : 'Save to favorites';
            favBtn.style.opacity = isSignedIn() ? '0.95' : '0.55';
        }

        if (favBtn) {
            favBtn.addEventListener('click', () => {
                if (!isSignedIn()) {
                    openLoginModal('login');
                    return;
                }
                const nm = (place.textContent || '').trim();
                if (!nm || lastLat == null || lastLon == null) return;
                if (inFavorites(nm)) { removeFavorite(nm); } else { saveFavorite(nm, lastLat, lastLon); }
                updateFavoriteIcon();
                renderFavorites();
            });
        }

        // Initialize auth UI and heart state on load
        updateAuthUI();
        updateFavoriteIcon();
    </script>

    <!-- Login Modal -->
    <div id="loginModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.7); align-items:center; justify-content:center;">
        <div style="background:white; color:black; padding:2rem; border-radius:1rem; width:90%; max-width:420px; box-shadow:0 10px 40px rgba(0,0,0,0.5); position:relative;">
            <span onclick="closeLoginModal()" style="position:absolute; top:1rem; right:1rem; cursor:pointer; font-size:1.5rem;">&times;</span>
            <h2 id="loginTitle" style="font-size:1.25rem; margin-bottom:0.75rem;">Sign in to save your favorite locations</h2>
            <p style="margin-bottom:1rem;">Save favorite places and sync them across devices.</p>
            <input id="loginEmail" type="email" placeholder="Email"
                   style="width:100%; padding:0.6rem; margin-bottom:0.75rem; border:1px solid #ccc; border-radius:0.5rem;">
            <input id="loginPass" type="password" placeholder="Password"
                   style="width:100%; padding:0.6rem; margin-bottom:0.75rem; border:1px solid #ccc; border-radius:0.5rem;">
            <label style="display:flex; align-items:center; margin-bottom:0.75rem; font-size:0.9rem;">
                <input id="loginRemember" type="checkbox" style="margin-right:0.5rem;"> Remember me on this device
            </label>
            <button id="loginAction" onclick="handleLogin()"
                    style="width:100%; padding:0.75rem; background:#3b82f6; color:white; border:none; border-radius:0.5rem;">
                Login
            </button>
            <p id="toggleCreate" style="text-align:center; margin-top:1rem;">
                Don’t have an account? <a href="#" id="toCreate">Create account</a>
            </p>
        </div>
    </div>
</body>
</html>